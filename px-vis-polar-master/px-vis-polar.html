<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-chart.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-common.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-d3.html"/>
<link rel="import" href="../px-vis/px-vis-radial-scale.html"/>
<link rel="import" href="../px-vis/px-vis-svg-canvas.html"/>
<link rel="import" href="../px-vis/px-vis-scatter.html"/>
<link rel="import" href="../px-vis/px-vis-line-svg.html"/>
<link rel="import" href="../px-vis/px-vis-scatter-canvas.html"/>
<link rel="import" href="../px-vis/px-vis-line-canvas.html"/>
<link rel="import" href="../px-vis/px-vis-interaction-space.html"/>
<link rel="import" href="../px-vis/px-vis-axis.html"/>
<link rel="import" href="../px-vis/px-vis-tooltip.html"/>
<link rel="import" href="../px-vis/px-vis-register.html"/>
<link rel="import" href="../px-vis/px-vis-clip-path.html"/>
<link rel="import" href="../px-vis/px-vis-radial-gridlines.html"/>
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html" />
<link rel="import" href="../px-colors-design/colors.html"/>
<link rel="import" href="../px-vis/px-vis-toolbar.html"/>
<link rel="import" href="../px-vis/px-vis-cursor.html"/>
<link rel="import" href="css/px-vis-polar-styles.html">
<link rel="import" href="../px-vis/px-vis-highlight-point.html"/>
<link rel="import" href="../px-vis/px-vis-highlight-point-canvas.html"/>
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html"/>

<!--
The	px-vis-polar component allows to draw a phase and amplitude on a polar plot. Initial height and width can be set but the component will try to fill its parent container on resize. It can be manually notified to recalculate its size by using notifyResize(). The chart is expecting the phase in radians but can use degrees by using the useDegrees property.

##### Usage

```
    <px-vis-polar
        id="chart"
        chart-data="{{data}}"
        margin='{ "top": "0", "bottom": "40", "left": "50", "right": "10" }'
        register-config='{
            "type": "vertical"}'
        series-config='{
            "firstSerie": {
            "name": "Data",
            "yAxisUnit": "m/s",
            "y": "amplitudeId",
            "x":"phaseId"
            }
        }'
        show-tooltip
        time-data="x"
        time-domain="[[selectedDomain]]">
    </px-vis-polar>
```

### Styling
The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
  `--px-vis-axis-color` | The color for the axis lines, axis ticks, and axis tick labels | `$gray9`
  `--px-vis-axis-title-color` | The color for the axis title | `$gray9`
  `--px-vis-axis-inline-title-color` | The color for the axis title  | `$gray9`
  `--px-vis-axis-inline-type-color` | The color for the axis lines, axis ticks, and axis tick labels when using 'inline' labelPosition | `$white`
  `--px-vis-axis-inline-box-color` | The color for the tick boxes when using 'inline' labelPosition | `$gray9`
  |  |
  |  |
  |  |
  `--px-vis-gridlines-color` | The color for the gridlines | `$gray3`
  |  |
  |  |
  |  |
  `--px-vis-register-series-name` | The color of the data series name | `$gray5`
  `--px-vis-register-data-value` | The color of the data series value | `$black`
  `--px-vis-register-box` | The color of the box around the register when a scrollbar is present | `$gray3`
  |  |
  |  |
  |  |
  `--px-vis-series-color-0` | These are the colors used to represent the data series on the charts. Used in numerical order by default. Colors MUST start at 0 and cannot contain gaps between numbers. | `$d-dv-basic-1`
  `--px-vis-series-color-1` |  | `$d-dv-basic-2`
  `--px-vis-series-color-2` |  | `$d-dv-basic-3`
  `--px-vis-series-color-3` |  | `$d-dv-basic-4`
  `--px-vis-series-color-4` |  | `$d-dv-basic-5`
  `--px-vis-series-color-5` |  | `$d-dv-basic-6`
  `--px-vis-series-color-6` |  | `$d-dv-basic-7`
  `--px-vis-series-color-7` |  | `$d-dv-basic-8`
  `--px-vis-series-color-8` |  | `$d-dv-basic-9`
  `--px-vis-series-color-9` |  | `$d-dv-basic-10`
  `--px-vis-series-color-10` |  | `$d-dv-bright-1`
  `--px-vis-series-color-11` |  | `$d-dv-bright-2`
  `--px-vis-series-color-12` |  | `$d-dv-bright-3`
  `--px-vis-series-color-13` |  | `$d-dv-bright-4`
  `--px-vis-series-color-14` |  | `$d-dv-bright-5`
  `--px-vis-series-color-15` |  | `$d-dv-bright-6`
  `--px-vis-series-color-16` |  | `$d-dv-bright-7`
  `--px-vis-series-color-17` |  | `$d-dv-bright-8`
  `--px-vis-series-color-18` |  | `$d-dv-bright-9`
  `--px-vis-series-color-19` |  | `$d-dv-bright-10`
  `--px-vis-series-color-20` |  | `$d-dv-muted-1`
  `--px-vis-series-color-21` |  | `$d-dv-muted-2`
  `--px-vis-series-color-22` |  | `$d-dv-muted-3`
  `--px-vis-series-color-23` |  | `$d-dv-muted-4`
  `--px-vis-series-color-24` |  | `$d-dv-muted-5`
  `--px-vis-series-color-25` |  | `$d-dv-muted-6`
  `--px-vis-series-color-26` |  | `$d-dv-muted-7`
  `--px-vis-series-color-27` |  | `$d-dv-muted-8`
  `--px-vis-series-color-28` |  | `$d-dv-muted-9`
  `--px-vis-series-color-29` |  | `$d-dv-muted-10`
  |  |
  |  |
  |  |
  `--px-tooltip-background-color` | The color of the tooltip | `$black`;
  `--px-tooltip-text-color` | The color of the tooltip text | `$white`;
  `--px-tooltip-light-background-color` | The color of the light version tooltip | `$white`;
  `--px-tooltip-light-text-color` | The color of the light version tooltip text | `$black`;
  `--px-tooltip-light-border-color`| The color of the light version tooltip border |  `$black`;
  |  |
  |  |
  |  |
  `--px-font-family` | The font family for all labels and text | `GE Inspira Sans`


@element px-vis-polar
@blurb The	px-vis-polar component allows to draw a phase and amplitude on a polar plot. Initial height and width can be set but the component will try to fill its parent container on resize. It can be manually notified to recalculate its size by using notifyResize(). The chart is expecting the phase in radians but can use degrees by using the useDegrees property.
@homepage index.html
@demo index.html
-->

<dom-module id="px-vis-polar">
  <template>
    <style include="px-vis-polar-styles"></style>


    <div id="wrapper" class$="{{_chartWrapperClass}}">
      <!-- Legend -->
      <div id="svgWrapper">
        <!-- Core -->
        <px-vis-radial-scale
          id="scale"
          width="[[_radius]]"
          height="[[_radius]]"
          margin="[[margin]]"
          chart-data="[[chartData]]"
          x="{{x}}"
          y="{{y}}"
          domain-changed="{{domainChanged}}"
          selected-domain="[[selectedDomain]]"
          complete-series-config="[[completeSeriesConfig]]"
          amplitude-keys="[[_amplitudeKey]]"
          use-degrees="[[useDegrees]]">
        </px-vis-radial-scale>
        <div class$="{{_registerWrapperClass}}">
          <px-vis-register
            id="register"
            class$="{{_getHideClass(hideRegister)}}"
            dynamic-menu-config="[[dynamicMenuConfig]]"
            tooltip-data="[[tooltipData]]"
            chart-data="[[_filteredData]]"
            complete-series-config="[[completeSeriesConfig]]"
            muted-series={{mutedSeries}}
            type="{{_registerType}}"
            x-axis-type="linear"
            y-axis-type="linear">
          </px-vis-register>
          <div class="flex flex--col">
            <px-vis-toolbar
              id="toolbar"
              current-sub-config='[[toolbarSubConfig]]'
              action-config='{{actionConfig}}'
              within-chart
              chart-margin="[[margin]]"
              show-tooltip="{{_internalShowTooltip}}">
            </px-vis-toolbar>
            <px-vis-svg-canvas
              class="inline--flex"
              id="svg"
              width="[[_smallerSide]]"
              height="[[_smallerSide]]"
              canvas-context="{{canvasContext}}"
              canvas-context-top="{{canvasContextTop}}"
              svg="{{svg}}"
              px-svg-elem="{{pxSvgElem}}"
              svg-lower="{{svgLower}}"
              offset="[[_center]]">
            </px-vis-svg-canvas>
          </div>

          <px-vis-interaction-space
            id="interactionSpace"
            chart-id="[[chartId]]"
            svg="[[layer.6]]"
            width="[[_radius]]"
            height="[[_radius]]"
            radial
            use-degrees="[[useDegrees]]"
            counter-clockwise="[[counterClockwise]]"
            x="[[x]]"
            y="[[y]]"
            domain-changed="[[domainChanged]]"
            use-quadtree
            series-keys="[[_seriesKeys]]"
            chart-data="[[_filteredData]]"
            default-empty-data="[[defaultEmptyData]]"
            tooltip-data="{{tooltipData}}"
            crosshair-data="{{crosshairData}}"
            generating-crosshair-data="{{generatingCrosshairData}}"
            x-axis-type="linear"
            y-axis-type="linear"
            complete-series-config="[[completeSeriesConfig]]"
            mouse-rect="{{mouseRect}}"
            series-keys="[[_seriesKeys]]"
            time-data="[[timeData]]"
            action-config='[[actionConfig]]'
            show-tooltip="{{_computedShowTooltip}}"
            prevent-web-worker-synchronization="[[preventWebWorkerSynchronization]]"
            ww-data-sync-counter="[[wwDataSyncCounter]]">
          </px-vis-interaction-space>

          <!-- scatter series -->

          <template is="dom-if" if="[[renderToCanvas]]" restamp>
            <template is="dom-repeat" items="[[_seriesKeys]]">
              <px-vis-scatter-canvas
                canvas-context="[[canvasContext]]"
                series-id="[[item]]"
                chart-data="[[_filteredData]]"
                complete-series-config="[[completeSeriesConfig]]"
                radial
                width="[[_diameter]]"
                height="[[_diameter]]"
                clip-path
                counter-clockwise="[[counterClockwise]]"
                use-degrees="[[useDegrees]]"
                x="[[x]]"
                y="[[y]]"
                no-canvas-progressive-rendering="[[noCanvasProgressiveRendering]]"
                progressive-rendering-points-per-frame="[[progressiveRenderingPointsPerFrame]]"
                progressive-rendering-minimum-frames="[[progressiveRenderingMinimumFrames]]"
                domain-changed="[[domainChanged]]"
                muted-series="[[mutedSeries]]"
                serie-to-redraw-on-top="[[serieToRedrawOnTop]]">
              </px-vis-scatter-canvas>
              <px-vis-line-canvas
                id="lineCanvas"
                canvas-context="[[canvasContext]]"
                series-id="[[item]]"
                chart-data="[[_filteredData]]"
                complete-series-config="[[completeSeriesConfig]]"
                radial-line
                counter-clockwise="[[counterClockwise]]"
                use-degrees="[[useDegrees]]"
                x="[[x]]"
                y="[[y]]"
                domain-changed="[[domainChanged]]"
                muted-series="[[mutedSeries]]"
                no-canvas-progressive-rendering="[[noCanvasProgressiveRendering]]"
                progressive-rendering-points-per-frame="[[progressiveRenderingPointsPerFrame]]"
                progressive-rendering-minimum-frames="[[progressiveRenderingMinimumFrames]]"
                serie-to-redraw-on-top="[[serieToRedrawOnTop]]">
              </px-vis-line-canvas>
            </template>
          </template>
          <template is="dom-if" if="[[!renderToCanvas]]" restamp>
            <template is="dom-repeat" items="[[_seriesKeys]]">
              <px-vis-scatter
                svg="[[layer.3]]"
                series-id="[[item]]"
                chart-data="[[_filteredData]]"
                radial
                width="[[_diameter]]"
                height="[[_diameter]]"
                clip-path
                counter-clockwise="[[counterClockwise]]"
                use-degrees="[[useDegrees]]"
                x="[[x]]"
                y="[[y]]"
                domain-changed="[[domainChanged]]"
                muted-series="[[mutedSeries]]"
                complete-series-config="[[completeSeriesConfig]]"
                time-data="{{timeData}}">
              </px-vis-scatter>
              <px-vis-line-svg
                svg="[[layer.2]]"
                radial-line
                counter-clockwise="[[counterClockwise]]"
                use-degrees="[[useDegrees]]"
                series-id="[[item]]"
                chart-data="[[_filteredData]]"
                muted-series="[[mutedSeries]]"
                x="[[x]]"
                y="[[y]]"
                domain-changed="[[domainChanged]]"
                complete-series-config="[[completeSeriesConfig]]">
              </px-vis-line-svg>
            </template>
          </template>
        </div>
      </div>
      <px-vis-cursor
        horizontal-line="full"
        vertical-line="full"
        circle-point="yes"
        radial
        counter-clockwise="[[counterClockwise]]"
        use-degrees="[[useDegrees]]"
        svg="[[layer.5]]"
        width="[[_radius]]"
        height="[[_radius]]"
        margin="[[_internalCircleMargins]]"
        chart-data="[[_filteredData]]"
        tooltip-data="[[tooltipData]]"
        complete-series-config="[[completeSeriesConfig]]"
        muted-series="[[mutedSeries]]"
        offset="[[offset]]">
      </px-vis-cursor>
      <!-- the 4 axis -->
      <template is="dom-repeat" items="[[_axisConfigArray]]">
        <px-vis-axis
          svg="[[layer.4]]"
          axis="[[y]]"
          height="[[item.height]]"
          width="[[item.width]]"
          title="[[item.title]]"
          title-location="[[item.titleLocation]]"
          rotation="[[item.rotation]]"
          orientation="[[item.orientation]]"
          label-rotation="[[item.labelRotation]]"
          label-translation="[[item.labelTranslation]]"
          label-type-size="[[item.labelTypeSize]]"
          title-type-size="[[item.titleTypeSize]]"
          ticks="[[_getNumberOfTick(_radius)]]"
          margin="[[margin]]"
          complete-series-config="[[completeSeriesConfig]]"
          prevent-series-bar
          domain-changed="[[domainChanged]]"
          label-position="inline"
          axis-color="grey4"
          drawn-tick-values="{{_drawnTickValues}}">
        </px-vis-axis>
      </template>
      <px-vis-radial-gridlines
        id="gridlines"
        svg="[[svgLower]]"
        axis="[[y]]"
        domain-changed="[[domainChanged]]"
        margin="[[margin]]"
        tick-values="[[_drawnTickValues]]">
      </px-vis-radial-gridlines>
      <px-vis-tooltip
        id="tooltip"
        tooltip-data="[[tooltipData]]"
        chart-data="[[_filteredData]]"
        muted-series="[[mutedSeries]]"
        x-axis-type="linear"
        y-axis-type="linear"
        complete-series-config="[[completeSeriesConfig]]"
        hover-target="[[mouseRect]]"
        mouse-position="[[mousePosition]]"
        tooltip-style="light"
        hide="[[!_computedShowTooltip]]">
      </px-vis-tooltip>

      <template id="highlighterDomIf" is="dom-if" if="[[renderToCanvas]]" restamp>
        <px-vis-highlight-point-canvas
          id="highlighterCanvas"
          radial
          counter-clockwise="[[counterClockwise]]"
          use-degrees="[[useDegrees]]"
          width="[[_diameter]]"
          height="[[_diameter]]"
          canvas-context="[[canvasContextTop]]"
          layers-to-mask="[[canvasContext]]"
          x="[[x]]"
          y="[[y]]"
          domain-changed="[[domainChanged]]"
          time-data="[[timeData]]"
          complete-series-config="[[completeSeriesConfig]]"
          series-keys="[[_seriesKeys]]"
          chart-data="[[chartData]]"
          generating-crosshair-data="[[generatingCrosshairData]]"
          default-empty-data="{{defaultEmptyData}}"
          tooltip-data="{{tooltipData}}"
          crosshair-data="[[crosshairData]]">
        </px-vis-highlight-point-canvas>
      </template>
      <template is="dom-if" if="[[!renderToCanvas]]" restamp>
        <px-vis-highlight-point
          id="highlighter"
          radial
          counter-clockwise="[[counterClockwise]]"
          use-degrees="[[useDegrees]]"
          svg="[[layer.5]]"
          layers-to-mask="[[getSvgLayersToMask(layer)]]"
          x="[[x]]"
          y="[[y]]"
          domain-changed="[[domainChanged]]"
          time-data="[[timeData]]"
          complete-series-config="[[completeSeriesConfig]]"
          chart-data="[[chartData]]"
          generating-crosshair-data="[[generatingCrosshairData]]"
          default-empty-data="{{defaultEmptyData}}"
          tooltip-data="{{tooltipData}}"
          crosshair-data="[[crosshairData]]">
        </px-vis-highlight-point>
      </template>

    </div>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-polar',
    behaviors: [
      PxVisBehaviorD3.svg,
      PxVisBehaviorD3.axes,
      PxVisBehaviorD3.selectedDomain,
      PxVisBehaviorD3.clipPath,
      PxVisBehavior.dataset,
      PxVisBehavior.mutedSeries,
      PxVisBehaviorChart.circleChart,
      PxVisBehavior.tooltipData,
      PxVisBehavior.extentsData,
      PxVisBehavior.axisTypes,
      PxVisBehavior.completeSeriesConfig,
      PxVisBehaviorChart.chartCommon,
      PxVisBehaviorChart.saveImage,
      PxVisBehaviorChart.subConfiguration,
      PxVisBehaviorD3.domainUpdate,
      PxVisBehavior.polarData,
      PxVisBehaviorChart.timeFiltering,
      PxVisBehaviorChart.chartAutoResize,
      PxVisBehaviorChart.registerPositioning,
      PxVisBehaviorChart.layers,
      PxColorsBehavior.baseColors,
      PxColorsBehavior.dataVisColorTheming,
      PxVisBehavior.dynamicMenuConfig,
      PxVisBehaviorChart.actionRequest,
      PxVisBehaviorChart.registerConfigs,
      PxVisBehaviorChart.showTooltip ,
      PxVisBehaviorChart.toolbarSubConfig,
      PxVisBehaviorChart.chartToolbarConfig,
      PxVisBehavior.actionConfig,
      PxVisBehaviorD3.canvasContext,
      PxVisBehaviorD3.renderToCanvas,
      PxVisBehaviorChart.tooltipFollowMouseCalculation,
      PxVisBehaviorChart.highlighterConfigs,
      PxVisBehavior.crosshairData,
      PxVisBehaviorChart.webWorkerSynchronization,
      Polymer.AppLocalizeBehavior
    ],
    /**
    * Properties block
    *
    * @property properties
    * @type Object
    */
    properties: {

      /**
       * configuration for the 4 axis and how to draw them/their labels
       */
      _axisConfigArray: {
        type: Array,
        computed: '_computeAxisConfig(_diameter, counterClockwise, y, axisLabels)'
      },
      /**
       * whether the polar data should be interepreted clockwise or counter-clockwise
       */
      counterClockwise: {
        type: Boolean,
        value: false
      },
      /**
       * used for the radial scale
       */
      _amplitudeKey: {
        type: String,
        computed: '_computeAmplitudeKey(completeSeriesConfig)'
      },
      /**
       * Returned tick values from the axis
       *
       */
      _drawnTickValues: {
        type: Array,
        notify: true
      },
      /**
       * Labels to be used for axis. Provide them sorted clockwise,
       * the chart will reorder them if needed.
       * default [0,90,180,270]
       */
      axisLabels: {
        type: Array,
        value: function () {
          return ['0°','90°','180°','270°'];
        }
      },
      /**
       * Font size for the unit label
       */
      unitLabelFontSize: {
        type: Number,
        value: 15
      },
      /**
       * Font size for the clockwise/counter clockwise label
       */
      clockwiseLabelFontSize: {
        type: Number,
        value: 15
      },
      /**
       * <g> element used to draw the clockwise/counter clockwise label
       */
      _clockwiseLabelGroup: {
        type: Object
      },
      /**
       * <g> element used to draw the unit label
       */
      _unitLabelGroup: {
        type: Object
      },
      mouseRect: {
        type: Object
      },
      /**
       * List of key/values to be included for translating this component
       */
      resources: {
        type: Object,
        value: function() {
          return {
            'en': {
              'clockwise': 'clockwise',
              'counter clockwise': 'counter clockwise'
            }
          };
        }
      },
      /**
      * set a default for localizing
      */
      language: {
        type: String,
        value: 'en'
      },
      /**
      * Use the key for localization if value for  language is missing. Should
      * always be true for  our components
      */
      useKeyIfMissing: {
        type: Boolean,
        value: true
      }
    },

    listeners: {
     'iron-resize': '_onIronResize'
    },

    observers: [
      '_drawUnitLabel(svg, completeSeriesConfig.*, _radius, unitLabelFontSize)',
      '_drawClockwiseLabel(svg, _radius, counterClockwise, clockwiseLabelFontSize, localize)',
      '_createLayersOnce(svg, numberOfLayers)',
      '_keepDataInSync(_filteredData.*, chartId)',
      '_seriesKeysChanged(_seriesKeys.*)',

      '_tooltipConfigChanged(tooltipConfig)',
      '_registerConfigChanged(registerConfig)',
      '_highlighterConfigChanged(highlighterConfig.*)',
      '_toolbarConfigChanged(toolbarConfig)',
      '_interactionSpaceConfigChanged(interactionSpaceConfig.*)',
      '_langChanged(language)'
    ],
    detached: function() {
      this.unlisten(this.$.highlighterDomIf, 'dom-change', '_highlighterConfigChanged');
    },
    created: function() {
      this._tooltipCalcHoverTargetId = 'wrapper';
    },
    ready: function() {
      this._wwSyncDataPropName = '_filteredData';
      //set defaults if they have not been set
      if(!this.defaultSeriesConfig.markerFillOpacity) {
        this.defaultSeriesConfig.markerFillOpacity = '0.5';
      }
      if(!this.defaultSeriesConfig.markerStrokeOpacity) {
        this.defaultSeriesConfig.markerStrokeOpacity = '0';
      }
      if(!this.defaultSeriesConfig.xAxisUnit) {
        this.defaultSeriesConfig.xAxisUnit = '°';
      }

      // only listen to one since it is a toggle
      this.listen(this.$.highlighterDomIf, 'dom-change', '_highlighterConfigChanged');

      this.set('numberOfLayers',7);

      //use some default internal margins to make space for labels
      this.set('_internalCircleMargins', {top: 30, right: 0, bottom: 60,left: 10});

      //make sure the change is processed... might be a better way
      this._setCompleteSeriesConfig();
    },

    _tooltipConfigChanged: function(conf) {
      this._applyConfigToElement(this.tooltipConfig, this.$.tooltip);
    },

    _registerConfigChanged: function(conf) {
      this._applyConfigToElement(this.registerConfig, this.$.register);
    },

    _toolbarConfigChanged: function(conf) {
      this._applyConfigToElement(this.toolbarConfig, this.$.toolbar);
    },

    _interactionSpaceConfigChanged: function(interactionSpaceConfig) {
      this._applyConfigToElement(this.interactionSpaceConfig, this.$.interactionSpace)
    },

    _highlighterConfigChanged: function(conf) {
      var elem = this.renderToCanvas ? this.$$('#highlighterCanvas') : this.$$('#highlighter');
      if(elem && this._doesObjHaveValues(this.highlighterConfig)) {
        this._applyConfigToElement(this.highlighterConfig, elem);
      }
    },

    _seriesKeysChanged: function() {
      //make sure we clean the canvas so that ols series are removed
      if(this.renderToCanvas && this.canvasContext && this.canvasContext.pxClearCanvas) {
        this.canvasContext.pxClearCanvas();
      }
    },

    _onIronResize: function() {
      if(!this.preventResize) {
        this.debounce('ironresize', function() {

          if(!this.preventResize) {
            var wrapperRect = this.$.wrapper.getBoundingClientRect(),
                toolbarRect = this.$.toolbar.getBoundingClientRect(),
                registerRect = this.$.register.getBoundingClientRect(),
                widthDeduct = 0,
                heightDeduct = 0;

            heightDeduct += toolbarRect.height;

            if(this.$.register.type === 'horizontal') {
              heightDeduct += registerRect.height;
            } else {
              widthDeduct += registerRect.width;
            }

            this.set('width', Math.max(wrapperRect.width - widthDeduct, 0));
            this.set('height', Math.max(wrapperRect.height - heightDeduct, 0));
          }

        }, this.debounceResizeTiming);
      }
    },

    /**
     * take an array of values aimed at clockwise and return one usable in
     * counter clockwise: swap value 1 and 3
     */
    _adjustArrayForCounterclockwise: function(arr) {
      var result = [];
      result[0] = arr[0];
      result[1] = arr[3];
      result[2] = arr[2];
      result[3] = arr[1];
      return result;
    },

    /**
     * Builds a config object used to build our 4 axis
     */
    _computeAxisConfig: function(diameter, counterClockwise, y, axisLabels) {

      var angles = [0,90,180,270],
          anchors = ['middle', 'start', 'middle', 'end'],
          result = [],
          axisLength = y.range()[1] - y.range()[0],
          labelToGrid = 10,
          halfLabelHeight = 5,
          tickRectHalfWidth = 6,
          labels = axisLabels,
          fontSize = 15;

      //if counter clockwise adjust various values
      if(this.counterClockwise) {
        angles = this._adjustArrayForCounterclockwise(angles);
        labels = this._adjustArrayForCounterclockwise(labels);
      }

      //build 4 config objects, one for each axis
      for( var i=0; i<4; i++) {
        var config = {},
            titleLoc = {};
        config.title = labels[i];
        config.width = axisLength;
        config.rotation = -angles[i] + 180;
        config.orientation = 'custom';
        config.labelTypeSize = 12;
        config.titleTypeSize = fontSize;
        config.height = axisLength;
        //since we rotate the axis we need to rotate the tick labels as well
        config.labelRotation = !this.counterClockwise ? 180 + (i * 90) % 360 : (180) - i * 90;
        config.labelTranslation = [0,4];

        //MATH. positioning the 4 labels appropriately at the end of their axis
        titleLoc.x = Number(Math.cos((i-1) * Math.PI/2) * (axisLength + labelToGrid + tickRectHalfWidth));
        titleLoc.y = halfLabelHeight + Number(Math.sin((i-1) * Math.PI/2) * (axisLength + labelToGrid + halfLabelHeight + tickRectHalfWidth));

        titleLoc.r = 0;
        titleLoc.anchor = anchors[i];
        config.titleLocation = titleLoc;

        result.push(config);
      }

      return result;
    },

    /**
     * amplitude keys are needed by the radial scale so we have to
     * artificially build them
     */
    _computeAmplitudeKey: function(completeSeriesConfig) {

      return Object.keys(completeSeriesConfig).map(function(serie) {
        return completeSeriesConfig[serie].y;
      });
    },

    _drawUnitLabel: function(svg, completeSeriesConfig, _radius, unitLabelFontSize) {
      //fetch unit from first config...
      var seriesId = Object.keys(this.completeSeriesConfig),
          unit,
          angle = Math.PI/4,
          length = this._radius + 10;

      //create the svg if needed
      if(!this._unitLabelGroup) {
        this.set('_unitLabelGroup', this.svg.append('g').attr('class','unit-group'));
        this._unitLabelGroup.append('text');
      }

      //find first unit...
      for(var i=0; i<seriesId.length; i++) {
        if(!unit) {
          unit = this.completeSeriesConfig[seriesId[i]].yAxisUnit
        } else {
          break;
        }
      }

      //make sure text is up to date
      this._unitLabelGroup.selectAll('text')
            .text(unit)
            .attr('font-size', unitLabelFontSize + 'px')
            .style('font-family',this._checkThemeVariable("--px-font-family", 'GE Inspira Sans'))
            .attr('fill', this._checkThemeVariable("--px-vis-axis-inline-title-color", this.colors['grey4']));

      //place label
      this._unitLabelGroup.attr('transform','translate(' + (Math.cos(angle) * length) +
              ',' + (-Math.sin(angle) * length) + ')');
    },

    _drawClockwiseLabel: function(svg, _radius, counterClockwise, fontSize) {

      //fetch unit from first config...
      var angle = -Math.PI/2,
          length = this._radius + 55;

      //create the svg if needed
      if(!this._clockwiseLabelGroup) {
        this.set('_clockwiseLabelGroup', this.svg.append('g').attr('class','clockwise-group'));
        this._clockwiseLabelGroup.append('text');
      }

      //make sure text is up to date
      this._clockwiseLabelGroup.selectAll('text')
            .text(!counterClockwise ? this.localize('clockwise') : this.localize('counter clockwise'))
            .attr('font-size', fontSize + 'px')
            .style('font-family',this._checkThemeVariable("--px-font-family", 'GE Inspira Sans'))
            .attr('fill', this._checkThemeVariable("--px-vis-axis-inline-title-color", this.colors['grey4']))
            .attr('text-anchor', 'middle');

      //place label
      this._clockwiseLabelGroup.attr('transform','translate(' + (Math.cos(angle) * length) +
              ',' + (-Math.sin(angle) * length) + ')');
    },

    /**
     * process  how many ticks we want on our axis, depending on size
     */
    _getNumberOfTick: function(_radius) {
      return Math.min(Math.max(_radius/70,2),7);
    },
    _langChanged: function() {

      //recreate X and Y in case d3 locale changed
      this.$.scale._recreateScales();
    },
    getSvgLayersToMask: function() {
      return [this.layer[2], this.layer[3]];
    }
  });
</script>
